from django.shortcuts import redirect, render
from .models import *
from django.contrib.auth.models import User
from django.contrib.auth.forms import UserCreationForm
from django.contrib import messages
from django.contrib.auth import authenticate, login,logout
from django.contrib.auth.decorators import login_required
# Create your views here.

@login_required(login_url='/login/')
def home(request):
    return render(request,'home.html')

@login_required(login_url='/login/')
def files(request):
    if request.method=="POST":
        data=request.POST
        file=request.FILES['file']
        malware.objects.create(
            file=file,
            )
    return render(request,'files.html')

@login_required(login_url='/login/')
def images(request):
    if request.method=="POST":
        data=request.POST
        image=request.FILES.get('image')
        malware.objects.create(
            image=image,
            )
    return render(request,'images.html')

@login_required(login_url='/login/')
def links(request):
    if request.method=="POST":
        data=request.POST
        links=request.FILES['links']
        malware.objects.create(
            links=links,
            )
    return render(request,'links.html')

def login_page(request):
    if request.method=="POST":
        username = request.POST.get('username')
        password = request.POST.get('password')

        if not User.objects.filter(username = username).exists():
            messages.info(request, "Invalid Username")
            return redirect('/login/')
        user = authenticate(username=username, password=password)

        if user is None:
            messages.error(request,'Invalid Username or Password')
            return redirect('/login/')

        else:
            login(request,user)
            return redirect("/")

    return render(request, 'login.html')

@login_required(login_url='/login/')
def logout_page(request):
    logout(request)
    return redirect('/login/')

def register(request):
    if request.method=="POST":
        first_name = request.POST.get('first_name')
        last_name = request.POST.get('last_name')
        username = request.POST.get('username')
        password = request.POST.get('password')


        user_exists = User.objects.filter(username = username).exists()
        

        if user_exists:
            messages.info(request, "Username already exists ")
            return redirect('/register/')
        

        user = User.objects.create(
            first_name=first_name,
            last_name=last_name,
            username=username,
        )
        user.set_password(password)  # Hash the password before saving it in the database
        user.save()
        messages.info(request, "Account Successfully created")
        # return HttpResponseRedirect('/login/')
        return redirect('/register/')


    return render(request, 'register.html')